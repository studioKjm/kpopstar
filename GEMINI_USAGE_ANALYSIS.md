# Gemini API 사용량 분석 및 최적화 방안

## 📊 현재 사용량 분석

### 문제 상황
- **에러**: 429 Quota Exceeded (할당량 초과)
- **발생 시점**: 12월 25일
- **원인**: 무료 티어의 일일/분당 요청 한도 초과

### 사용량 패턴 (대시보드 기준)
- **12월 4일**: 약 50-53 요청 (큰 스파이크)
- **입력 토큰**: 약 20K-50K 사용
- **12월 25일**: 429 에러 3개 발생

## 🔍 코드 분석 결과

### 주요 문제점

#### 1. **전체 검수 기능의 병렬 실행**
```typescript
// src/lib/ai/features/index.ts:223
const [factCheck, styleAnalysis, duplicateCheck, sensitivityCheck] = await Promise.all([
  checkFacts(content, title, subtitle),
  unifyStyle(content),
  checkDuplicates(content),
  checkSensitivity(content),
]);
```
- **문제**: 한 번에 4개 API 요청을 동시에 실행
- **영향**: 분당 요청 제한(RPM)을 빠르게 소진

#### 2. **전체 본문 전송**
- 각 기능마다 전체 기사 본문을 전송
- 긴 기사의 경우 토큰 사용량이 매우 큼
- 예: 2000자 기사 → 약 500-800 토큰/요청

#### 3. **캐싱 부재**
- 동일한 내용에 대한 중복 호출 방지 없음
- 사용자가 여러 번 클릭 시 중복 요청 발생

#### 4. **요청 빈도 제한 없음**
- 사용자가 빠르게 여러 기능을 연속 클릭 가능
- 분당 제한을 초과할 위험

## 📋 Gemini API 무료 티어 제한사항

### Gemini 2.0 Flash (현재 사용 중)
- **일일 요청**: 약 15-20회 (최근 변경됨)
- **분당 요청 (RPM)**: 약 15회
- **분당 토큰 (TPM)**: 약 1M 토큰
- **일일 토큰**: 제한 있음

### 참고
- 할당량은 매일 오전 10시(한국 시간) 리셋
- 무료 티어는 최근 대폭 축소됨 (일일 20회로 감소)

## 🛠️ 최적화 방안

### 1. 전체 검수 순차 실행으로 변경 (우선순위: 높음)
```typescript
// 병렬 → 순차 실행으로 변경
// 한 번에 1개씩 실행하여 RPM 제한 회피
```

### 2. 본문 길이 제한 및 요약 전송 (우선순위: 높음)
```typescript
// 2000자 이상이면 요약 후 전송
// 또는 청크 단위로 나누어 처리
```

### 3. 요청 빈도 제한 추가 (우선순위: 중간)
```typescript
// 사용자별/세션별 요청 간격 제한
// 예: 최소 5초 간격
```

### 4. 캐싱 추가 (우선순위: 중간)
```typescript
// 동일한 내용에 대한 결과 캐싱
// 메모리 또는 로컬 스토리지 활용
```

### 5. 사용량 모니터링 및 경고 (우선순위: 낮음)
```typescript
// 일일 사용량 추적
// 한도에 근접 시 경고 표시
```

## 💡 즉시 적용 가능한 조치

1. **전체 검수 기능 비활성화 또는 순차 실행으로 변경**
2. **본문 길이 제한 추가** (예: 1500자 이상이면 경고)
3. **사용자 안내 메시지 개선** (할당량 정보 표시)

## 📈 예상 효과

- **요청 수 감소**: 전체 검수 시 4회 → 4회 (순차 실행으로 RPM 제한 회피)
- **토큰 사용량 감소**: 본문 길이 제한 시 약 30-50% 감소 예상
- **에러 발생 감소**: 요청 빈도 제한으로 429 에러 예방

## 🔗 참고 링크

- [Gemini API 할당량 확인](https://ai.dev/usage?tab=rate-limit)
- [Google AI Studio](https://aistudio.google.com/)
- [Gemini API 문서](https://ai.google.dev/gemini-api/docs)

